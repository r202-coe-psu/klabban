{% macro base_render(
field,
id="",
id_prefix="",
class_="",
placeholder="",
prefix="",
suffix="",
disabled=False,
readonly=False,
disabled_optional_text=True,
is_hidden=False
) %}

{# ตั้งค่าเริ่มต้น placeholder จาก wtform #}
{% set placeholder = placeholder if placeholder != "" else field.render_kw.placeholder %}

{#% set style = "input input-bordered flex items-center gap-2 w-full" %#}
{% set style = "input flex items-center gap-2 w-full" %}
{% set field_id = id_prefix + field.id %}

{% if field.errors | count > 0 %}
  {% set style = style + " input-error" %}
{% endif %}

{% if readonly or disabled %}
  {% set style = style + " input-readonly" %}
{% endif %}

{% if field.type == "SelectField" or field.type == "ModelSelectField" %}
  {% set style = style.replace("input", "select") + ' appearance-none' %}
{% endif %}

{% if class_ != "" %}
  {% set style = style + " " + class_ %}
{% endif %}

{% if is_hidden %}
  {% set style = style + " hidden" %}
{% endif %}

{% if field.type == "HiddenField" %}
{{ field(**kwargs) }}
{% else %}
<fieldset class="w-full fieldset" id="field-{{ field.id }}">
  <legend class="fieldset-legend">
    {{ field.label.text }}
    {% if field.flags.required %}
    <span class="text-error">*</span>
    {% endif %}
    {% if not field.flags.required and not disabled_optional_text %}
    <p class="fieldset-label">(ไม่บังคับ)</p>
    {% endif %}
  </legend>
  <label class="w-full validator {{style}} {% if is_hidden %}hidden{% endif %}">
    {% if prefix %}
    {{ prefix_icon }}
    {% endif %}
    {{ field(placeholder=placeholder, readonly=readonly, class="appearance-none", **kwargs) }}
    {% if suffix %}
    {{ suffix_icon }}
    {% endif %}
  </label>
  {% if field.errors %}
  <span class="validator-hint">
    {% for error in field.errors %}
    {% if 'This field is required' in error %}
    กรุณากรอกข้อมูล
    {% else %}
    {{ error }}
    {% endif %}
    {% if not loop.last %}<br>{% endif %}
    {% endfor %}
  </span>
  {% endif  %}
</fieldset>
{% endif %}
{% endmacro %}

{% macro render_search_checkbox_list(field, id_prefix='', placeholder="", disabled=false, unit="จังหวัด") %}
{% set field_id = id_prefix + field.id %}
{% set list_of_tuples = field.choices %}
{% set selected_values = field.data if field.data else [] %}
{% set unique_choices = dict(field.choices) %}
{% if not placeholder %}
{% set placeholder = "ค้นหา" + field.label.text %}
{% endif %}

<fieldset class="w-full fieldset" id="field-{{ field_id }}">
  <legend class="fieldset-legend">{{ field.label.text }}
    {% if field.flags.required %}
    <span class="text-error">*</span>
    {% endif %}
  </legend>

  <!-- ช่องค้นหา -->
  <div class="mb-2">
    <input type="text" id="{{ field_id }}-search" placeholder="{{ placeholder }}" class="input input-bordered w-full "
      oninput="filterCheckboxList('{{ field_id }}')">
  </div>

  <!-- ปุ่มควบคุม -->
  <div class="flex justify-between items-center mb-3">
    <div class="text-sm text-gray-600" id="{{ field_id }}-count">
      เลือกแล้ว: {{ selected_values|length }} {{ unit }}
    </div>
    <div class="flex gap-2">
      <button type="button" class="btn btn-sm btn-outline" onclick="selectAllCheckboxes('{{ field_id }}')">
        เลือกทั้งหมด
      </button>
      <button type="button" class="btn btn-sm btn-outline" onclick="clearAllCheckboxes('{{ field_id }}')">
        ล้างทั้งหมด
      </button>
    </div>
  </div>

  <!-- รายการ Checkbox -->
  <div id="{{ field_id }}-list"
    class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-2 max-h-72 overflow-auto border rounded-lg p-2">
    {% for value, label in list_of_tuples %}
    <label class="flex items-center gap-2 cursor-pointer p-1 rounded hover:bg-gray-50 transition-colors">
      <input type="checkbox" name="{{ field.name }}" value="{{ value }}" id="{{ field_id }}-chk-{{ value }}"
        class="checkbox checkbox-sm" {% if value in selected_values %}checked{% endif %} {% if disabled %}disabled{%
        endif %} onchange="updateCheckboxCount('{{ field_id }}')">
      <span>{{ label }}</span>
    </label>
    {% endfor %}
    <div class="flex justify-between items-center w-full" id="{{ field_id }}-no-data"
      style="{% if list_of_tuples|length > 0 %}display: none;{% endif %}">
      ไม่พบข้อมูล
    </div>

  </div>

  {% if field.errors %}
    <p class="validator-hint text-error">
      {% for error in field.errors %}
      {{ error }}{% if not loop.last %}<br>{% endif %}
      {% endfor %}
    </p>
  {% endif %}
</fieldset>

<script>
  function updateCheckboxCount(fieldId) {
    const checkboxes = document.querySelectorAll(`#${fieldId}-list input[type='checkbox']`);
    const selected = Array.from(checkboxes).filter(chk => chk.checked).length;
    const countEl = document.getElementById(`${fieldId}-count`);
    if (countEl) countEl.textContent = `เลือกแล้ว: ${selected} {{ unit }}`;
  }

  function selectAllCheckboxes(fieldId) {
    const checkboxes = document.querySelectorAll(`#${fieldId}-list input[type='checkbox']`);
    checkboxes.forEach(chk => chk.checked = true);
    updateCheckboxCount(fieldId);
  }

  function clearAllCheckboxes(fieldId) {
    const checkboxes = document.querySelectorAll(`#${fieldId}-list input[type='checkbox']`);
    checkboxes.forEach(chk => chk.checked = false);
    updateCheckboxCount(fieldId);
  }

  function filterCheckboxList(fieldId) {
    const search = document.getElementById(`${fieldId}-search`).value.toLowerCase();
    const items = document.querySelectorAll(`#${fieldId}-list label`);
    items.forEach(label => {
      const text = label.textContent.toLowerCase();
      label.style.display = text.includes(search) ? "" : "none";
    });
    const noDataEl = document.getElementById(`${fieldId}-no-data`);
    const anyVisible = Array.from(items).some(label => label.style.display !== "none");
    if (noDataEl) noDataEl.style.display = anyVisible ? "none" : "";
  }

  document.addEventListener("DOMContentLoaded", function () {
    updateCheckboxCount('{{ field_id }}');
  });
</script>
{% endmacro %}

{% macro render_checkbox_list_no_search(field, id_prefix='', disabled=false, unit="รายการ") %}
{% set field_id = id_prefix + field.id %}
{% set list_of_tuples = field.choices %}
{% set selected_values = field.data if field.data else [] %}

<fieldset class="w-full fieldset" id="field-{{ field_id }}">
  <legend class="fieldset-legend">{{ field.label.text }}
    {% if field.flags.required %}
    <span class="text-error">*</span>
    {% endif %}
  </legend>

  <div class="flex justify-between items-center mb-2">
    <div class="text-sm text-gray-600" id="{{ field_id }}-count">
      เลือกแล้ว: {{ selected_values|length }} {{ unit }}
    </div>
    <div class="flex gap-2">
      <button type="button" class="btn btn-xs btn-outline" onclick="selectAllCheckboxes('{{ field_id }}')" {% if
        disabled %}disabled{% endif %}>
        เลือกทั้งหมด
      </button>
      <button type="button" class="btn btn-xs btn-outline" onclick="clearAllCheckboxes('{{ field_id }}')" {% if disabled
        %}disabled{% endif %}>
        ล้าง
      </button>
    </div>
  </div>

  <div id="{{ field_id }}-list"
    class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-2 max-h-72 overflow-auto border rounded-lg p-2 bg-base-100">
    {% for value, label in list_of_tuples %}
    <label class="flex items-center gap-2 cursor-pointer p-1 rounded hover:bg-base-200 transition-colors">
      <input type="checkbox" name="{{ field.name }}" value="{{ value }}" id="{{ field_id }}-chk-{{ value }}"
        class="checkbox checkbox-sm" {% if value in selected_values %}checked{% endif %} {% if disabled %}disabled{%
        endif %} onchange="updateCheckboxCount('{{ field_id }}', '{{ unit }}')">
      <span class="text-sm">{{ label }}</span>
    </label>
    {% else %}
    <div class="col-span-full text-center text-gray-500 py-4">
      ไม่พบข้อมูล
    </div>
    {% endfor %}
  </div>

  {% if field.errors %}
    <p class="validator-hint text-error mt-1 text-sm">
      {% for error in field.errors %}
      {{ error }}{% if not loop.last %}<br>{% endif %}
      {% endfor %}
    </p>
  {% endif %}
</fieldset>

<script>
  // ป้องกันการประกาศฟังก์ชันซ้ำหากเรียกใช้ macro หลายครั้งในหน้าเดียว
  if (typeof window.updateCheckboxCount === 'undefined') {
    window.updateCheckboxCount = function (fieldId, unitStr) {
      const checkboxes = document.querySelectorAll(`#${fieldId}-list input[type='checkbox']`);
      const selected = Array.from(checkboxes).filter(chk => chk.checked).length;
      const countEl = document.getElementById(`${fieldId}-count`);
      if (countEl) countEl.textContent = `เลือกแล้ว: ${selected} ${unitStr}`;
    }

    window.selectAllCheckboxes = function (fieldId) {
      const checkboxes = document.querySelectorAll(`#${fieldId}-list input[type='checkbox']:not([disabled])`);
      checkboxes.forEach(chk => chk.checked = true);
      // หา unit จาก text เดิม หรือส่งเข้ามาใหม่ (ในที่นี้ให้ trigger change event เพื่อความง่ายถ้าทำได้)
      // หรือเรียก updateCheckboxCount โดยดึง unit จาก DOM เดิม
      const countEl = document.getElementById(`${fieldId}-count`);
      if (countEl) {
        const unitStr = countEl.textContent.split(' ').pop(); // ดึงคำสุดท้ายมาเป็น unit
        updateCheckboxCount(fieldId, unitStr);
      }
    }

    window.clearAllCheckboxes = function (fieldId) {
      const checkboxes = document.querySelectorAll(`#${fieldId}-list input[type='checkbox']:not([disabled])`);
      checkboxes.forEach(chk => chk.checked = false);
      const countEl = document.getElementById(`${fieldId}-count`);
      if (countEl) {
        const unitStr = countEl.textContent.split(' ').pop();
        updateCheckboxCount(fieldId, unitStr);
      }
    }
  }

  // Initial count update สำหรับ field นี้
  document.addEventListener("DOMContentLoaded", function () {
    updateCheckboxCount('{{ field_id }}', '{{ unit }}');
  });
</script>
{% endmacro %}


{% macro render_text_area_field(field,readonly=False) %}
<fieldset class="fieldset" id="field-{{ field.id }}">
  <legend class="fieldset-legend">
    {{ field.label.text }}
  </legend>
  <textarea {% if readonly %} readonly {% endif %} class="w-full h-24 textarea bg-white rounded-3xl"
    name="{{ field.name }}" id="{{ field.id }}"
    placeholder="กรอก{{ field.label.text }}ที่นี่">{{ field.data if field.data else field.default if field.default else "" }}</textarea>
  {% if field.errors %}
    <div class="fieldset-label">
      <p class="validator-hint">
        {% for error in field.errors %}
        {% if 'This field is required' in error %}
        กรุณากรอกข้อมูล
        {% else %}
        {{ error }}
        {% endif %}
        {% if not loop.last %}<br>{% endif %}
        {% endfor %}
      </p>
    </div>
  {% endif %}
</fieldset>
{% endmacro %}

{% macro render_checkbox_field(field, class_="", checked_label="อุปสมบทได้", unchecked_label="อุปสมบทไม่ได้") %}
<fieldset class="w-full fieldset" id="field-{{ field.id }}">
  <legend class="fieldset-legend">
    {{ field.label.text }}
  </legend>

  <div class="flex items-center gap-3 mt-2">
    <input type="checkbox" id="{{ field.id }}" name="{{ field.name }}" class="checkbox checkbox-sm {{ class_ }}" {% if
      field.data %}checked{% endif %}
      onclick="document.getElementById('{{ field.id }}_text').textContent = this.checked ? '{{ checked_label }}' : '{{ unchecked_label }}';
                document.getElementById('{{ field.id }}_text').className = this.checked ? 'text-green-600' : 'text-black';" />
    <span id="{{ field.id }}_text" class="{% if field.data %}text-green-600{% else %}text-black{% endif %}">
      {% if field.data %}
      {{ checked_label }}
      {% else %}
      {{ unchecked_label }}
      {% endif %}
    </span>
  </div>
</fieldset>
{% endmacro %}

{% macro render_select_field(
field,
type="select",
class_="",
placeholder="",
prefix_icon="",
suffix_icon="",
top_left_label="",
top_right_label="",
bottom_left_label="",
bottom_right_label="",
disabled=False,
disabled_optional_text=False,
readonly=False) %}
{% set style = "select flex items-center gap-2 w-full" %}

{% if field.errors | count > 0 %}
{% set style = style + " " + (type ~ "-error") %}
{% endif %}

{% if class_ %}
{% set style = style + " " + class_ %}
{% endif %}

<fieldset class="w-full fieldset" id="field-{{ field.id }}">
  <legend class="fieldset-legend">
    {{ field.label.text }}
    {% if field.flags.required %}
    <span class="text-error">*</span>
    {% endif %}
  </legend>

  {% if readonly or disabled %}
  {{ field(placeholder=placeholder, class_=style + " input-readonly", disabled=disabled, **kwargs) }}
  <input type="hidden" name="{{ field.name }}" value="{{ field.data }}">
  {% else %}
  {{ field(class_=style, **kwargs) }}
  {% endif %}

  <span class="validator-hint">
    {% for error in field.errors %}
    {% if 'This field is required' in error %}
    กรุณากรอกข้อมูล
    {% else %}
    {{ error }}
    {% endif %}
    {% if not loop.last %}<br>{% endif %}
    {% endfor %}
  </span>
</fieldset>
{% endmacro %}

{% macro text_input(id, name, label, placeholder, value='', required=false, wrapper_classes='', additional_text='') %}
<div class="w-full {{wrapper_classes}} px-3 mb-6 md:mb-0">
  <label class="label" for="{{ id }}">
    <span class="label-text text-black">
      {{ label }} {% if required %}<span class="text-red-500">*</span>{% endif %}
    </span>
  </label>
  <input type="text" id="{{ id }}" name="{{ name }}" placeholder="{{ placeholder }}" value="{{ value }}" {% if required
    %}required{% endif %} class="input border-0 rounded-lg w-full bg-gray-200">
  {% if additional_text %}
  <h2 class="text-sm text-gray-500 mt-1">{{ additional_text }}</h2>
  {% endif %}
</div>
{% endmacro %}

{% macro number_input(id, name, label, placeholder='', value='', required=false, wrapper_classes='', min='', max='',
step='', additional_text='') %}
<div class="w-full {{ wrapper_classes }} px-3 mb-6 md:mb-0">
  <label class="label" for="{{ id }}">
    <span class="label-text text-black">
      {{ label }} {% if required %}<span class="text-red-500">*</span>{% endif %}
    </span>
  </label>
  <input type="number" id="{{ id }}" name="{{ name }}" placeholder="{{ placeholder }}" value="{{ value }}" {% if
    required %}required{% endif %} {% if min %}min="{{ min }}" {% endif %} {% if max %}max="{{ max }}" {% endif %} {% if
    step %}step="{{ step }}" {% endif %} class="input border-0 rounded-lg w-full bg-gray-200">
  {% if additional_text %}
  <h2 class="text-sm text-gray-500 mt-1 text-center">{{ additional_text }}</h2>
  {% endif %}
</div>
{% endmacro %}

{% macro select_input(id, name, label, options, selected='', placeholder='', required=false, wrapper_classes='',
additional_text='', onchange='', field=none) %}
{% if field %}
{% set id = field.id %}
{% set name = field.name %}
{% set label = field.label.text %}
{% set options = field.choices %}
{% set selected = field.data %}
{% set required = field.flags.required %}
{% endif %}
<div class="w-full {{ wrapper_classes }} px-3 mb-6 md:mb-0">
  <label class="label" for="{{ id }}">
    <span class="label-text text-black">
      {{ label }} {% if required %}<span class="text-red-500">*</span>{% endif %}
    </span>
  </label>
  <select id="{{ id }}" name="{{ name }}" class="select select-bordered w-full border-0 rounded-lg bg-gray-200" {% if
    required %}required{% endif %} {% if onchange %}onchange="{{ onchange }}" {% endif %}>
    {% if placeholder %}
    <option value="" disabled {% if not selected %}selected{% endif %}>{{ placeholder }}</option>
    {% endif %}

    {% if options %}
    {% set first_item = options[0] %}
    {# ตรวจสอบว่าเป็น list_1: สมาชิกตัวแรกเป็น tuple หรือ list (มี value และ label) #}
    {% if first_item is iterable and first_item is not string %}
    {# โค้ดสำหรับ list_1 (มี value และ label) #}
    {% for value, label in options %}
    <option value="{{ value }}" {% if value==selected %}selected{% endif %}>
      {{ label }}
    </option>
    {% endfor %}

    {# ตรวจสอบว่าเป็น list_2: สมาชิกตัวแรกเป็นค่าเดี่ยว (data) #}
    {% else %}
    {# โค้ดสำหรับ list_2 (มีแต่ data ให้ใช้เป็น value และ label) #}
    {% for data in options %}
    <option value="{{ data }}" {% if data==selected %}selected{% endif %}>
      {{ data }}
    </option>
    {% endfor %}
    {% endif %}
    {% endif %}
  </select>
  {% if additional_text %}
  <h2 class="text-sm text-gray-500 mt-1">{{ additional_text }}</h2>
  {% endif %}
</div>
{% endmacro %}


{% macro list_input(id, name, label, items=[], placeholder='', add_button_label='เพิ่ม', remove_button_label='ลบ',
wrapper_classes='', additional_text='') %}
<div class="w-full {{ wrapper_classes }} px-3 mb-6 md:mb-0">
  <label class="label" for="{{ id }}">
    <span class="label-text text-black">
      {{ label }}
    </span>
  </label>

  <div class="flex items-center gap-2 mb-2">
    <input type="text" id="{{ id }}_input" class="input border-0 rounded-lg w-full bg-gray-200"
      placeholder="{{ placeholder }}">
    <button type="button" class="btn rounded-lg bg-orange-700 text-white" onclick="addItem('{{ id }}')">
      {{ add_button_label }}
    </button>
  </div>

  <div id="{{ id }}_list" class="w-full mt-2 space-y-2">

    {% for index, item in items %}
    <div class="flex items-center justify-between p-3 bg-gray-100 rounded-lg shadow-sm">

      <span class="text-sm">{{ index + 1 }}. {{ item }}</span>

      <button type="button" class="btn btn-sm btn-ghost" onclick="removeItem('{{ id }}', this)">
        <i class="ph ph-x text-red-500 text-base"></i>
      </button>
    </div>
    {% endfor %}
  </div>

  <div id="{{ id }}_hidden"></div>

  {% if additional_text %}
  <h2 class="text-sm text-gray-500 mt-1">{{ additional_text }}</h2>
  {% endif %}
</div>

<script>
  function addItem(listId) {
    const input = document.getElementById(`${listId}_input`);
    const list = document.getElementById(`${listId}_list`);

    if (input.value.trim() === '') {
      alert('กรุณากรอกข้อมูล');
      return;
    }

    const item = document.createElement('div');
    item.className = 'flex items-center justify-between p-3 bg-gray-200 rounded-lg';
    item.innerHTML = `
            <span class="text-sm">${input.value.trim()}</span>
            <button type="button" class="btn btn-sm btn-ghost" onclick="removeItem('${listId}', this)">
                <i class="ph ph-x text-red-500 text-base"></i>
            </button>
        `;

    // เพิ่มรายการใหม่ที่ท้ายสุด (appendChild แทน insertBefore)
    list.appendChild(item);

    updateItemIndices(listId);

    input.value = '';
  }

  function removeItem(listId, button) {
    const item = button.closest('.flex.items-center.justify-between');
    const list = document.getElementById(`${listId}_list`);

    if (item) {
      list.removeChild(item);
      updateItemIndices(listId);
    }
  }

  function updateItemIndices(listId) {
    const list = document.getElementById(`${listId}_list`);
    Array.from(list.children).forEach((child, index) => {
      const span = child.querySelector('span');
      if (span) {
        // หาข้อความเดิม (เผื่อข้อความมี . อยู่)
        const textParts = span.textContent.split('. ');
        // ถ้า textParts มีมากกว่า 1 ส่วน (คือมีเลขนำหน้า) ให้เอาตั้งแต่ส่วนที่ 2 มารวมกัน
        // ถ้ามีแค่ 1 ส่วน (คือยังไม่มีเลข) ก็ใช้ข้อความเดิม
        const text = textParts.length > 1 ? textParts.slice(1).join('. ') : span.textContent;

        span.textContent = `${index + 1}. ${text}`;
      }
    });
  }
</script>
{% endmacro %}

{% macro search_select_input(id, name, label, options, selected='', placeholder='Search...', required=false,
wrapper_classes='', additional_text='', field=none) %}
{% if field %}
{% set id = field.id %}
{% set name = field.name %}
{% set label = field.label.text %}
{% set options = field.choices if field.choices else [] %}
{% set selected = field.data %}
{% set required = field.flags.required %}
{% endif %}
<div class="w-full {{ wrapper_classes }} px-3 mb-6 md:mb-0">
  <label class="label" for="{{ id }}_search" onclick="document.getElementById('{{ id }}-input').focus();">
    <span class="label-text text-black">
      {{ label }} {% if required %}<span class="text-red-500">*</span>{% endif %}
    </span>
  </label>

  <div class="relative w-full dropdown">
    <!-- Visible text input used for searching / showing chosen label -->
    <input id="{{ id }}-input" type="text" class="input border-0 rounded-lg w-full bg-gray-200"
      placeholder="{{ placeholder }}" autocomplete="off" aria-haspopup="listbox" aria-expanded="false" {% if required
      %}required{% endif %}
      value="{% if selected %}{% for v,l in options %}{% if v == selected %}{{ l }}{% endif %}{% endfor %}{% endif %}"
      oninput="updateHiddenValue('{{ id }}'); filterDropdown('{{ id }}')" onfocus="showDropdown('{{ id }}')"
      onblur="validateInputValue('{{ id }}')" />

    <!-- Hidden input used for form submission -->
    <input id="{{ id }}" name="{{ name }}" type="hidden" value="{{ selected }}" />

    <!-- Dropdown -->
    <ul id="{{ id }}-dropdown"
      class="absolute z-50 left-0 right-0 mt-1 bg-white rounded-lg shadow max-h-56 overflow-auto hidden border border-gray-200"
      role="listbox" aria-labelledby="{{ id }}-input">
      {% for value, label_option in options %}
      <li class="px-3 py-2 cursor-pointer hover:bg-gray-100 border-b border-gray-100 last:border-b-0"
        data-value="{{ value }}" role="option"
        onclick="selectDropdownValue('{{ id }}', '{{ value }}', '{{ label_option }}')" {% if value==selected
        %}aria-selected="true" {% endif %}>
        {{ label_option }}
      </li>
      {% endfor %}
    </ul>
  </div>

  {% if additional_text %}
  <h2 class="text-sm text-gray-500 mt-1 text-center">{{ additional_text }}</h2>
  {% endif %}

  <!-- Error messages -->
  <p class="validator-hint text-error text-sm mt-1 hidden" id="{{ id }}-error">
    กรุณาเลือกค่าที่ถูกต้องจากรายการ
  </p>
</div>

<script>
  // Prevent script duplication
  if (typeof window.searchSelectFunctions === 'undefined') {
    window.searchSelectFunctions = true;

    window.filterDropdown = function (fieldId) {
      let input = document.getElementById(fieldId + "-input");
      let filter = input.value.toLowerCase();
      let dropdown = document.getElementById(fieldId + "-dropdown");
      let items = dropdown.getElementsByTagName("li");

      let hasMatch = false;
      for (let i = 0; i < items.length; i++) {
        let textValue = items[i].textContent || items[i].innerText;
        if (textValue.toLowerCase().indexOf(filter) > -1) {
          items[i].style.display = "";
          hasMatch = true;
        } else {
          items[i].style.display = "none";
        }
      }

      // Show/hide dropdown based on matches
      if (hasMatch && filter.length > 0) {
        dropdown.classList.remove('hidden');
      } else if (filter.length === 0) {
        dropdown.classList.remove('hidden'); // Show all when empty
      } else {
        dropdown.classList.add('hidden');
      }
    }

    window.showDropdown = function (fieldId) {
      let dropdown = document.getElementById(fieldId + "-dropdown");
      let input = document.getElementById(fieldId + "-input");

      // Close other dropdowns
      document.querySelectorAll('[id$="-dropdown"]').forEach(dd => {
        if (dd.id !== fieldId + "-dropdown") {
          dd.classList.add('hidden');
        }
      });

      dropdown.classList.remove('hidden');
      input.setAttribute('aria-expanded', 'true');
    }

    window.selectDropdownValue = function (fieldId, value, label) {
      let input = document.getElementById(fieldId + "-input");
      let hiddenInput = document.getElementById(fieldId);
      let dropdown = document.getElementById(fieldId + "-dropdown");
      let errorMsg = document.getElementById(fieldId + "-error");

      input.value = label;  // Display label in input
      hiddenInput.value = value;  // Send value in hidden input

      // Clear validation error
      if (errorMsg) errorMsg.classList.add('hidden');
      input.setCustomValidity("");

      // Update aria-selected
      dropdown.querySelectorAll('li').forEach(li => {
        li.setAttribute('aria-selected', li.dataset.value === value ? 'true' : 'false');
      });

      dropdown.classList.add('hidden');  // Hide dropdown after selection
      input.setAttribute('aria-expanded', 'false');
    }

    window.updateHiddenValue = function (fieldId) {
      let input = document.getElementById(fieldId + "-input");
      let hiddenInput = document.getElementById(fieldId);
      let errorMsg = document.getElementById(fieldId + "-error");

      // Clear validation error while typing
      if (errorMsg) errorMsg.classList.add('hidden');
      input.setCustomValidity("");

      // Update hidden value to match input (allows custom entries)
      hiddenInput.value = input.value;
    }

    window.validateInputValue = function (fieldId) {
      // Add small delay to allow click events on dropdown items
      setTimeout(() => {
        let input = document.getElementById(fieldId + "-input");
        let hiddenInput = document.getElementById(fieldId);
        let dropdown = document.getElementById(fieldId + "-dropdown");
        let errorMsg = document.getElementById(fieldId + "-error");
        let valueEntered = input.value.trim();

        dropdown.classList.add('hidden');
        input.setAttribute('aria-expanded', 'false');

        // Skip validation if input is empty and not required
        if (valueEntered === "") {
          if (errorMsg) errorMsg.classList.add('hidden');
          input.setCustomValidity("");
          hiddenInput.value = "";
          return;
        }

        let items = dropdown.getElementsByTagName("li");
        let isValid = false;

        for (let i = 0; i < items.length; i++) {
          let label = (items[i].textContent || items[i].innerText).trim();
          if (label === valueEntered) {
            isValid = true;
            hiddenInput.value = items[i].getAttribute("data-value");
            break;
          }
        }

        if (!isValid) {
          // Show custom error message
          if (errorMsg) errorMsg.classList.remove('hidden');
          input.setCustomValidity("กรุณาเลือกค่าที่ถูกต้องจากรายการ");
        } else {
          if (errorMsg) errorMsg.classList.add('hidden');
          input.setCustomValidity("");
        }
      }, 150);
    }

    // Close dropdowns when clicking outside
    document.addEventListener("click", function (event) {
      let dropdowns = document.querySelectorAll('[id$="-dropdown"]');
      dropdowns.forEach(dropdown => {
        let container = dropdown.parentElement;
        if (!container.contains(event.target)) {
          dropdown.classList.add('hidden');
          let input = container.querySelector('input[aria-expanded]');
          if (input) input.setAttribute('aria-expanded', 'false');
        }
      });
    });

    // Keyboard navigation
    document.addEventListener('keydown', function (event) {
      if (event.target.matches('[id$="-input"]')) {
        let fieldId = event.target.id.replace('-input', '');
        let dropdown = document.getElementById(fieldId + "-dropdown");

        if (dropdown && !dropdown.classList.contains('hidden')) {
          let visibleItems = Array.from(dropdown.querySelectorAll('li')).filter(li =>
            li.style.display !== 'none'
          );
          let currentIndex = visibleItems.findIndex(li =>
            li.classList.contains('keyboard-focused')
          );

          if (event.key === 'ArrowDown') {
            event.preventDefault();
            visibleItems.forEach(li => li.classList.remove('keyboard-focused'));
            let nextIndex = currentIndex < visibleItems.length - 1 ? currentIndex + 1 : 0;
            if (visibleItems[nextIndex]) {
              visibleItems[nextIndex].classList.add('keyboard-focused');
              visibleItems[nextIndex].scrollIntoView({ block: 'nearest' });
            }
          } else if (event.key === 'ArrowUp') {
            event.preventDefault();
            visibleItems.forEach(li => li.classList.remove('keyboard-focused'));
            let prevIndex = currentIndex > 0 ? currentIndex - 1 : visibleItems.length - 1;
            if (visibleItems[prevIndex]) {
              visibleItems[prevIndex].classList.add('keyboard-focused');
              visibleItems[prevIndex].scrollIntoView({ block: 'nearest' });
            }
          } else if (event.key === 'Enter') {
            event.preventDefault();
            let focusedItem = dropdown.querySelector('li.keyboard-focused');
            if (focusedItem) {
              focusedItem.click();
            }
          } else if (event.key === 'Escape') {
            dropdown.classList.add('hidden');
            event.target.setAttribute('aria-expanded', 'false');
          }
        }
      }
    });
  }
</script>

<style>
  li.keyboard-focused {
    background-color: #f3f4f6 !important;
  }
</style>
{% endmacro %}




{% macro date_field(field, class_="", placeholder="", prefix_icon="", suffix_icon="", disabled=False,
readonly=False) %}
{% set style = "input flex items-center gap-2 w-full pr-8" %} {# เพิ่ม pr-8 เผื่อที่ให้ปุ่ม clear #}
{% if field.errors | count > 0 %}{% set style = style + " input-error" %}{% endif %}
{% if class_ != "" %}{% set style = style + " " + class_ %}{% endif %}

<fieldset class="fieldset w-full js-date-field-wrapper relative" id="field-{{ field.id }}"
  data-field-id="{{ field.id }}">
  <legend class="fieldset-legend">
    {{ field.label.text }}
    {% if field.flags.required %}<span class="text-error">*</span>{% endif %}
  </legend>

  <div class="relative w-full">
    <input type="hidden" id="{{ field.id }}" name="{{ field.name }}" class="js-date-input"
      value="{{ field.data|format_date('%Y-%m-%d') if field.data else ''}}" {% if disabled %}disabled{% endif %} {% if
      readonly %}readonly{% endif %}>

    <button type="button" id="cally-{{ field.id }}" class="{{ style }} js-date-button relative" {% if disabled
      %}disabled{% endif %}>
      <div class="flex items-center justify-between w-full">
        {# Display Span: ส่วนแสดงผล ต้องคำนวณ พ.ศ. เอง #}
        <span id="cally-data-{{ field.id }}" class="js-date-display"
          data-placeholder="{{ placeholder if placeholder else 'กรุณาเลือกวันที่' }}">
          {% if field.data %}
            {# *** แก้ไขจุดนี้: แสดงผล พ.ศ. โดยเอาปี + 543 *** #}
            {{ "{:02d}/{:02d}/{}".format(field.data.day, field.data.month, field.data.year + 543) }}
          {% else %}
            {{ placeholder if placeholder else 'กรุณาเลือกวันที่' }}
          {% endif %}
        </span>
        <span class="material-symbols-outlined calendar-icon" style="font-size: 18px;">
          calendar_month
        </span>
      </div>
    </button>

    <button type="button"
      class="absolute items-center right-8 top-1/2 -translate-y-1/2 text-red-400 hover:text-red-600 js-date-clear {% if not field.data %}hidden{% endif %}"
      {% if disabled or readonly %}hidden{% endif %}>
      <span class="material-symbols-outlined align-middle">
        cancel
      </span>
    </button>

    <div id="cally-popover-{{ field.id }}"
      class="absolute z-50 hidden shadow-lg dropdown bg-base-100 rounded-box js-date-popover">
      <div class="flex items-center gap-2 p-2">
        <select id="month-select-{{ field.id }}" class="select select-sm js-month-select">
          {% for m in range(1, 13) %}<option value="{{ m - 1 }}">{{ "{:02d}".format(m) }}</option>{% endfor %}
        </select>
        {# Year Select: Loop ปี พ.ศ. (2400-2700) #}
        <select id="year-select-{{ field.id }}" class="select select-sm js-year-select">
          {% for y in range(2400, 2700) %}<option value="{{ y }}">{{ y }}</option>{% endfor %}
        </select>
      </div>
      <div class="js-calendar-container"></div>
    </div>
  </div>
</fieldset>
{% endmacro %}

{% macro render_text_area_field(field, placeholder="", readonly=False) %}
<fieldset class="fieldset" id="field-{{ field.id }}">
  <legend class="fieldset-legend">
    {{ field.label.text }}
  </legend>
  <textarea {% if readonly %} readonly {% endif %} class="w-full h-24 textarea" name="{{ field.name }}"
    id="{{ field.id }}"
    placeholder="{{ placeholder }}">{{ field.data if field.data else field.default if field.default else "" }}</textarea>
  <div class="fieldset-label">
    <p class="validator-hint">
      {% for error in field.errors %}
      {% if 'This field is required' in error %}
      กรุณากรอกข้อมูล
      {% else %}
      {{ error }}
      {% endif %}
      {% if not loop.last %}<br>{% endif %}
      {% endfor %}
    </p>
  </div>
</fieldset>
{% endmacro %}


{% macro time_field(field, label=None, placeholder="HH:mm", disabled=False) %}
<fieldset class="fieldset w-full relative-container js-time-field-wrapper">
  <legend class="fieldset-legend">
    {{ label if label else field.label.text }}
    {% if field.flags.required %}<span class="text-error">*</span>{% endif %}
  </legend>

  <div class="relative w-full">
    <label
      class="input input-bordered w-full flex items-center gap-2 pr-10 {{ 'input-error' if field.errors else '' }}">
      {{ field(
            class="grow js-custom-time cursor-pointer",
            placeholder=placeholder,
            disabled=disabled,
            readonly=True, 
            type="text",
            autocomplete="off"
        ) }}

      <span class="material-symbols-outlined text-gray-700 clock-icon" style="font-size: 20px;">
        access_time
      </span>
    </label>

    <button type="button"
      class="absolute right-10 top-1/2 -translate-y-1/2 p-1 text-red-400 hover:text-red-600 js-time-clear hidden" {% if
      disabled %}hidden{% endif %}>
      <span class="material-symbols-outlined align-middle">
        cancel
      </span>
    </button>
  </div>

  <p class="validator-hint text-error mt-1 text-sm">
    {% for error in field.errors %}
    {{ error }}{% if not loop.last %}<br>{% endif %}
    {% endfor %}
  </p>
</fieldset>

<script>
  // ป้องกันการประกาศซ้ำหากเรียก Macro หลายครั้ง
  if (typeof window.initTimeField === 'undefined') {
    window.initTimeField = function (wrapper) {
      if (wrapper.dataset.initialized === 'true') return;

      const input = wrapper.querySelector('.js-custom-time');
      const clearBtn = wrapper.querySelector('.js-time-clear');
      const clockIcon = wrapper.querySelector('.clock-icon');
      if (!input || input.disabled) return;

      const pad = (num) => String(num).padStart(2, '0');
      let currentHour = null;
      let currentMin = null;

      // --- Helper: อัปเดตปุ่ม Clear ---
      const updateClearButton = () => {
        if (input.value && clearBtn) {
          clearBtn.classList.remove('hidden');
          clockIcon.style.display = 'none';
        } else if (clearBtn) {
          clearBtn.classList.add('hidden');
          clockIcon.style.display = 'block';
        }
      };

      // --- 1. สร้าง DOM ของ Dropdown ---
      const dropdown = document.createElement('div');
      dropdown.className = 'custom-time-dropdown';

      const hourCol = document.createElement('div');
      hourCol.className = 'time-column';
      hourCol.innerHTML = '<div class="column-header">ชม.</div>';
      for (let i = 0; i < 24; i++) {
        const option = document.createElement('div');
        option.className = 'time-option js-hour-option';
        option.dataset.val = pad(i);
        option.textContent = pad(i);
        hourCol.appendChild(option);
      }

      const minCol = document.createElement('div');
      minCol.className = 'time-column';
      minCol.innerHTML = '<div class="column-header">นาที</div>';
      for (let i = 0; i < 60; i += 5) { // ปรับ step นาทีได้ที่นี่ (เช่น i += 1, i += 5, i += 15)
        const option = document.createElement('div');
        option.className = 'time-option js-min-option';
        option.dataset.val = pad(i);
        option.textContent = pad(i);
        minCol.appendChild(option);
      }

      dropdown.appendChild(hourCol);
      dropdown.appendChild(minCol);
      // แปะ dropdown ต่อท้าย input container (ไม่ใช่ต่อท้าย input โดยตรง)
      input.closest('.relative').appendChild(dropdown);

      // --- 2. Event Handlers ---
      const updateInput = () => {
        if (currentHour !== null && currentMin !== null) {
          input.value = `${currentHour}:${currentMin}`;
          updateClearButton();
          input.dispatchEvent(new Event('change', { bubbles: true })); // Trigger change event
        }
      };

      const highlightCurrentSelection = () => {
        dropdown.querySelectorAll('.selected').forEach(el => el.classList.remove('selected'));
        if (input.value.includes(':')) {
          [currentHour, currentMin] = input.value.split(':');
          const hourOpt = hourCol.querySelector(`[data-val="${currentHour}"]`);
          const minOpt = minCol.querySelector(`[data-val="${currentMin}"]`);
          if (hourOpt) {
            hourOpt.classList.add('selected');
            hourOpt.scrollIntoView({ block: 'center' });
          }
          if (minOpt) {
            minOpt.classList.add('selected');
            minOpt.scrollIntoView({ block: 'center' });
          }
        }
      };

      hourCol.addEventListener('click', (e) => {
        if (e.target.classList.contains('js-hour-option')) {
          hourCol.querySelectorAll('.selected').forEach(el => el.classList.remove('selected'));
          e.target.classList.add('selected');
          currentHour = e.target.dataset.val;
          updateInput();
        }
      });

      minCol.addEventListener('click', (e) => {
        if (e.target.classList.contains('js-min-option')) {
          minCol.querySelectorAll('.selected').forEach(el => el.classList.remove('selected'));
          e.target.classList.add('selected');
          currentMin = e.target.dataset.val;
          updateInput();
        }
      });

      // เปิด/ปิด Dropdown
      input.closest('label').addEventListener('click', (e) => { // คลิกที่ label (รวมไอคอน) ก็เปิดได้
        if (e.target === clearBtn || clearBtn?.contains(e.target)) return; // ยกเว้นคลิกปุ่ม clear

        e.stopPropagation();
        document.querySelectorAll('.custom-time-dropdown.show').forEach(d => d !== dropdown && d.classList.remove('show'));
        dropdown.classList.toggle('show');
        if (dropdown.classList.contains('show')) {
          highlightCurrentSelection();
        }
      });

      // ปุ่ม Clear
      if (clearBtn) {
        clearBtn.addEventListener('click', (e) => {
          e.stopPropagation();
          input.value = '';
          currentHour = null;
          currentMin = null;
          dropdown.querySelectorAll('.selected').forEach(el => el.classList.remove('selected'));
          updateClearButton();
          input.dispatchEvent(new Event('change', { bubbles: true }));
        });
      }

      // ปิดเมื่อคลิกข้างนอก
      document.addEventListener('click', (e) => {
        if (!wrapper.contains(e.target)) {
          dropdown.classList.remove('show');
        }
      });

      // Initial check
      updateClearButton();
      wrapper.dataset.initialized = 'true';
    };
  }

  // Initialize ทันทีสำหรับ field นี้
  // (ถ้าเพิ่ม dynamic ต้องเรียก initTimeField(newItem) เองด้วย)
  document.addEventListener("DOMContentLoaded", function () {
    // ค้นหา wrapper ที่เป็น parent ของ script นี้โดยตรง (ถ้าทำได้) หรือ init ทั้งหมด
    // เพื่อความชัวร์ init ทั้งหมดที่มี class นี้ไปเลย
    document.querySelectorAll('.js-time-field-wrapper').forEach(window.initTimeField);
  });
</script>
{% endmacro %}

{% macro file_input(form, style=None, optionals={}) %}
{% set default_style = "w-full bg-primary/5 rounded border-primary border-dotted border-2 px-4 flex flex-col
items-center justify-center cursor-pointer mx-auto h-40 bg-white hover:bg-gray-100" %}
{% set style_ = style if style else default_style %}
{% set style_ = style_ + " input-error" if form.errors else style_ %}
{% set allowed_extensions = [] %}
{% for validator in form.validators %}
{% if validator.upload_set %}
{% set allowed_extensions = validator.upload_set %}
{% endif %}
{% endfor %}

<div class="form-control w-full" id="{{ form.id }}_dropzone">
  <label class="label">
    <span class="label-text">{{ form.label }}
      {% if form.flags.required %}<span class="label-text-alt text-red-600">*</span>{% endif %}
      <p class="text-gray-500">
        {% for validator in form.validators %}
        {% if validator.upload_set %}
        รองรับเฉพาะไฟล์ {{ ", ".join(validator.upload_set) }} เท่านั้น
        {% endif %}
        {% endfor %}
      </p>
    </span>
  </label>

  <div class="relative h-48 border-slate-50">
    {{ form(class="absolute hidden left-1/2 mt-2 z-[1] transform -translate-x-1/2",
    onchange="handleUploadedImage(this);", **optionals) }}

    <label for="{{ form.id }}" class='z-[10] top-0 bottom-0 absolute {{ style_ }}'>
      <div class="flex flex-col gap-2 items-center">
        <div>
          <span class="material-symbols-outlined" style="font-size: 30px; color: dimgrey;">
            cloud_upload
          </span>
        </div>
        <p class="text-gray-500">กดเพื่อเลือกไฟล์หรือลากและวางไฟล์ที่นี่</p>

        <div class=" text-sm items-center gap-2 hidden bg-primary/5 p-2 rounded-box" id="{{ form.id }}_label">
          <span class="text-primary icon-[mdi--file-image]" style="width: 1.25em; height: 1.25em;"></span>
          <span class="text-primary font-bold" id="{{ form.id }}_filename"></span>
        </div>
      </div>
    </label>
  </div>
</div>

<script type="text/javascript">
  const dropzone = document.getElementById('{{ form.id }}_dropzone');

  dropzone.addEventListener('dragenter', (event) => {
    event.preventDefault();
    dropzone.classList.add('active');
  });

  dropzone.addEventListener('dragover', (event) => {
    event.preventDefault();
  });

  dropzone.addEventListener('dragleave', (event) => {
    dropzone.classList.remove('active');
  });

  dropzone.addEventListener('drop', (event) => {
    event.preventDefault();
    dropzone.classList.remove('active');
    let files = event.dataTransfer.files;
    if (files.length > 0) {
      handleDroppedFiles(files, "{{ form.id }}");
    }
  });

  function handleUploadedImage(form) {
    document.getElementById(form.id + "_label").style.display = "flex";
    document.getElementById(form.id + "_filename").innerHTML = form.files[0].name;
  }

  function handleDroppedFiles(files, form_id) {
    document.getElementById(form_id + "_label").style.display = "flex";
    document.getElementById(form_id + "_filename").innerHTML = files[0].name;
    document.getElementById(form_id).files = files;
    document.getElementById(form_id).onchange();
  }
</script>
{% endmacro%}

{% macro render_multi_select_field(field, id_prefix='', placeholder="", disabled=false) %}
{% set field_id = id_prefix + field.id %}
{% set list_of_tuples = field.choices %}
{% set selected_values = field.data if field.data else [] %}
{% set unique_choices = dict(field.choices) %}
{% if not placeholder %}
{% set placeholder = "เลือก" + field.label.text %}
{% endif %}

<fieldset class="w-full fieldset" id="field-{{ field.id }}">
  <legend class="fieldset-legend">
    {{ field.label.text }}
    {% if field.flags.required %}
    <span class="text-error">*</span>
    {% endif %}
  </legend>

  <div class="relative w-full" id="{{ field_id }}-dropdown-container">
    <button {% if disabled %} disabled {% endif %} type="button" id="{{ field_id }}-btn"
      data-field-name="{{ field.name }}" tabindex="0"
      class="w-full select text-left {% if field.errors %}select-error{% endif %}"
      onclick="toggleMultiDropdown('{{ field_id }}')">
      {{ placeholder }}
    </button>

    {# Hidden inputs for selected values #}
    {% for val in selected_values %}
    <input type="hidden" name="{{ field.name }}" value="{{ val }}" id="{{ field_id }}-hidden-{{ val }}">
    {% endfor %}

    <ul id="{{ field_id }}-dropdown"
      class="absolute top-full left-0 menu bg-white z-10 w-full p-2 shadow-lg border rounded-box overflow-auto max-h-48" style="display: none;">
      {% for value, label in list_of_tuples %}
      <li>
        <p class="break-words cursor-pointer flex justify-between items-center" data-value="{{ value }}"
          onclick="selectMultiDropdownValue('{{ field_id }}', '{{ value }}', '{{ label }}', event)">
          <span>{{ label }}</span>
          <span class="text-primary {{ 'hidden' if value not in selected_values }}" id="{{ field_id }}-check-{{ value }}">✓</span>
        </p>
      </li>
      {% endfor %}
    </ul>
  </div>

  <div class="flex flex-wrap gap-1 mb-1" id="{{ field_id }}-selected-tags">
    {% for val in selected_values %}
    <span class="badge badge-primary flex items-center gap-1" id="{{ field_id }}-tag-{{ val }}">
      {{ unique_choices.get(val, val) }}
      {% if not disabled %}
      <button type="button" onclick="removeSelectedValue('{{ field_id }}', '{{ val }}')">✕</button>
      {% endif %}
    </span>
    {% endfor %}
  </div>
  <p class="validator-hint text-error">
    {% for error in field.errors %}
    {{ error }}{% if not loop.last %}<br>{% endif %}
    {% endfor %}
  </p>
</fieldset>

<script>
  function toggleMultiDropdown(fieldId) {
    const dropdown = document.getElementById(fieldId + "-dropdown");
    if (dropdown.style.display === "block") {
      dropdown.style.display = "none";
    } else {
      dropdown.style.display = "block";
    }
  }

  function hideMultiDropdown(fieldId) {
    document.getElementById(fieldId + "-dropdown").style.display = "none";
  }

  function selectMultiDropdownValue(fieldId, value, label, event) {
    if (event) event.stopPropagation();

    // Toggle: if already selected, remove it
    if (document.getElementById(fieldId + "-hidden-" + value)) {
      removeSelectedValue(fieldId, value);
      return;
    }

    const tag = document.createElement("span");
    tag.className = "badge badge-primary flex items-center gap-1";
    tag.id = fieldId + "-tag-" + value;
    tag.innerHTML = `${label} <button type="button" onclick="removeSelectedValue('${fieldId}', '${value}')">✕</button>`;

    const tagContainer = document.getElementById(fieldId + "-selected-tags");
    tagContainer.appendChild(tag);

    const hidden = document.createElement("input");
    hidden.type = "hidden";
    const fieldName = document.getElementById(fieldId + "-btn").dataset.fieldName;
    hidden.name = fieldName;
    hidden.value = value;
    hidden.id = fieldId + "-hidden-" + value;
    tagContainer.parentElement.insertBefore(hidden, tagContainer);

    // Show checkmark
    const checkmark = document.getElementById(fieldId + "-check-" + value);
    if (checkmark) checkmark.classList.remove("hidden");
  }

  function removeSelectedValue(fieldId, value) {
    const tag = document.getElementById(fieldId + "-tag-" + value);
    const hidden = document.getElementById(fieldId + "-hidden-" + value);
    if (tag) tag.remove();
    if (hidden) hidden.remove();

    // Hide checkmark
    const checkmark = document.getElementById(fieldId + "-check-" + value);
    if (checkmark) checkmark.classList.add("hidden");
  }

  function clearAllSelected(fieldId) {
    const tagContainer = document.getElementById(fieldId + "-selected-tags");
    tagContainer.innerHTML = "";

    const hiddenInputs = document.querySelectorAll(`input[id^="${fieldId}-hidden-"]`);
    hiddenInputs.forEach(input => input.remove());
  }

  document.addEventListener("click", function (event) {
    const allDropdownContainers = document.querySelectorAll("[id$='-dropdown-container']");
    allDropdownContainers.forEach(container => {
      if (!container.contains(event.target)) {
        const fieldId = container.id.replace("-dropdown-container", "");
        hideMultiDropdown(fieldId);
      }
    });
  });
</script>
{% endmacro %}