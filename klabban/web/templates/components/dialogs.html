{% import "base/html_renderer.html" as renderer %}

{% macro Dialog(
id,
title,
body,
class_="",
init_show=False,
click_outside_to_close=True,
close_at_corner=False,
method="GET",
disable_cancel_button=False,
cancel_button_text="ปิด",
cancel_button_href="",
cancel_button_onclick="",
cancel_button_color="",
action_button_text="",
action_button_type="action",
action_button_href="",
action_button_onclick="",
action_button_color="primary",
summit_button_color="primary",
summit_button_text="",
summit_button_type="submit",
refugee_name="",
bypass=false
) %}

{#
### วิธีใช้ Dialog 101 ###

id: ตั้งค่า id ให้แต่ละไดอะล็อก อาจจะเป็น id ของ model.id หรือ ชื่อ form.name

title: หัวเรื่องของไดอะล็อก

body: เนื้อหาของไดอะล็อก

init_show:
- True: ไดอะล็อกแสดงทันที
- False ไดอะล็อกจะต้องแสดงด้วย js ด้วยคำสั่ง $(#dialog_id)[0].showModal();

click_outside_to_close: ให้กดด้านนอกไดอะล็อคเพื่อปิดไหม?

close_at_corner: จะให้มีปุ่มปิดขวาบนไหม?

method: เป็น method ของ forms สำหรับปุ่มแอคชั่น ด้วย GET หรือ POST ค่าเริ่มต้นเป็น "GET"

cancel_button_text: ข้อความของปุ่มยกเลิก ค่าเริ่มต้นเป็นคำว่า "ปิด"
cancel_button_href: ถ้าหากจะให้ปุ่มยกเลิก redirect สามารถใส่ได้
cancel_button_color: สีของปุ่มยกเลิก

action_button_text: ข้อความของปุ่มแอคชั่น
action_button_type: ประเภทของ button ปุ่มแอคชั่น หากจะใช้ method="POST" ให้ใช้ action_button_type="submit"
action_button_color: สีของปุ่มแอคชั่น

action_button_href: ลิงค์สำหรับ redirect ของปุ่มแอคชั่น
action_button_onclick: ฟังก์ชัน javascript สำหรับปุ่มแอคชั่นถ้าหากไม่ใส่

** เลือกระหว่าง href หรือ onclick ว่าจะให้เป็นการ href หรือจะเป็นการใช้ฟังก์ชัน onclick
ระบบจะเรนเดอร์ href ก่อนหากใส่มาทั้ง 2
#}
<dialog id="{{ id }}" class="modal modal-bottom sm:modal-middle">
  <div class="modal-box {{ class_ }}">
    {% if close_at_corner %}
    {% if cancel_button_href %}
    <a href="{{ cancel_button_href }}" class="btn btn-sm btn-circle btn-ghost absolute right-2 top-2 outline-none">✕</a>
    {% else %}
    <button type="button" class="btn btn-sm btn-circle btn-ghost absolute right-2 top-2 outline-none"
      onclick="document.getElementById('{{ id }}').close();">✕</button>
    {% endif %}
    {% endif %}

    <h3 class="font-bold text-xl">{{ title | safe }}</h3>
    <p class="py-4 " style="overflow-wrap: break-word;">{{ body | safe }}</p>

    {% if refugee_name %}
    <p class="mb-2 text-gray-700">โปรดพิมพ์ชื่อผู้อพยพเพื่อยืนยัน: <strong>{{ refugee_name }}</strong></p>
    {# en #}
    <p class="mb-2 text-gray-700">Please type the refugee's name to confirm: <strong>{{ refugee_name }}</strong></p>
      <input class="border p-2 w-full" type="text" id="{{ id }}-refugee-name-input" value="" placeholder='{{ refugee_name }}' autocomplete="off" />
    {% endif %}

    <div class="modal-action">
      {% if not disable_cancel_button %}
      {% if cancel_button_href or cancel_button_onclick %}
      <a class="btn btn-{{ cancel_button_color }} outline-none" {% if cancel_button_href %}
        href="{{ cancel_button_href }}" {% endif %} {% if cancel_button_onclick %} onclick="{{ cancel_button_onclick}}"
        {% endif %}>
        {{ cancel_button_text | safe }}
      </a>
      {% else %}
      <form method="dialog">
        <button type="button" class="btn btn-{{ cancel_button_color }} outline-none"
          onclick="document.getElementById('{{ id }}').close();">{{ cancel_button_text | safe }}</button>
      </form>
      {% endif %}
      {% endif %}


      {% if action_button_text %}
      <form method="{{ method }}" action="{{ action_button_href }}">
        {% set action_tag = "button" if action_button_type == "submit" else "a" %}
        {% if action_button_href or action_button_onclick %}
        <{{action_tag}} class="btn btn-outline btn-{{ action_button_color }}" type="{{ action_button_type }}"
          onclick="{{ action_button_onclick}}">
          {{ action_button_icon | safe }}
          {{ action_button_text | safe }}
        </{{action_tag}}>
        {% endif %}
      </form>
      {% endif %}
      {% if summit_button_text %}
      {% set summit_tag = "button" if summit_button_type == "submit" else "a" %}
      <{{summit_tag}} class="btn btn-{{ summit_button_color }}" type="{{ summit_button_type }}">
        {{ summit_button_icon | safe }}
        {{ summit_button_text | safe }}
      </{{summit_tag}}>
      {% endif %}
    </div>
  </div>
  {% if click_outside_to_close %}
  <form method="dialog" class="modal-backdrop"><button>กดเพื่อปิด</button></form>
  {% endif %}
</dialog>

<script>
  {% if init_show %}
  document.getElementById("{{ id }}").showModal();
  {% endif %}

  {% if refugee_name %}
  (function() {
    const dialog = document.getElementById("{{ id }}");
    const input = dialog.querySelector('input[id="{{ id }}-refugee-name-input"]');
    const actionForm = dialog.querySelector('form[action="{{ action_button_href }}"]');
    const actionButton = actionForm ? actionForm.querySelector('.btn-outline') : dialog.querySelector('.modal-action .btn-outline');
    
    // --- จุดที่แก้ไข: เพิ่มเงื่อนไขตรวจสอบ Role ของ current_user ---
    // รวมเงื่อนไข: bypass เดิม OR เป็น admin OR เป็น refugee_camp_staff
    let bypass = {{ bypass }}
    // --------------------------------------------------------

    const targetName = "{{ refugee_name }}";

    if (!input || !actionButton) return;
    
    input.value = "";

    function validateInput() {
      // ถ้าเป็น bypass ให้ผ่านตลอด (ตรวจสอบแค่ trim หรือไม่ก็ได้ แล้วแต่ความต้องการ แต่ในที่นี้คือไม่ต้องตรงเป๊ะ)
      // หรือถ้าอยากให้ bypass คือไม่ต้องพิมพ์เลย ให้แก้เงื่อนไขเป็น if (bypass || input.value.trim() === targetName)
      if (bypass || input.value.trim() === targetName) {
        actionButton.removeAttribute('disabled');
        actionButton.classList.remove('btn-disabled');
        actionButton.classList.add('btn-{{ action_button_color }}');
        return true;
      } else {
        actionButton.setAttribute('disabled', 'disabled');
        actionButton.classList.remove('btn-{{ action_button_color }}');
        actionButton.classList.add('btn-disabled');
        return false;
      }
    }

    input.addEventListener('input', validateInput);

    actionButton.addEventListener('click', function(e) {
      if (!validateInput()) {
        e.preventDefault();
        e.stopPropagation();
        alert("ชื่อไม่ถูกต้อง! กรุณากรอกชื่อให้ตรงกับ '" + targetName + "' เพื่อยืนยัน\n\nIncorrect name! Please type '" + targetName + "' to confirm.");
        return false;
      }
    });

    input.addEventListener('keypress', function(e) {
      if (e.key === 'Enter') {
        if (!validateInput()) {
           e.preventDefault();
           alert("ชื่อไม่ถูกต้อง! กรุณากรอกชื่อให้ตรงกับ '" + targetName + "' เพื่อยืนยัน");
        }
      }
    });

    // เริ่มต้น: เรียก validateInput
    // ถ้าเป็น Admin/Staff (bypass=true) ปุ่มจะ Active ทันทีตั้งแต่เริ่ม
    validateInput();
    
  })();
  {% endif %}
</script>
{% endmacro %}

{% macro DisactiveDialog(id, title, body, url, refugee_name, action_button_type="submit", bypass=false, init_show=false) %}
{{
Dialog(
id=id,
title=title,
body=body,
method="POST",
close_at_corner=True,
cancel_button_text="ยกเลิก / cancels",
action_button_text="ยืนยัน / submit",
action_button_type=action_button_type,
action_button_color="primary",
action_button_href=url,
refugee_name=refugee_name,
bypass=bypass,
init_show=init_show
)
}}
{% endmacro %}





{% macro ChangeStatusDialog(
id,
title,
body,
class_="",
init_show=False,
click_outside_to_close=True,
close_at_corner=False,
method="GET",
disable_cancel_button=False,
cancel_button_text="ปิด",
cancel_button_href="",
cancel_button_onclick="",
cancel_button_color="",
action_button_text="",
action_button_type="action",
action_button_href="",
action_button_onclick="",
action_button_color="primary",
summit_button_color="primary",
summit_button_text="",
summit_button_type="submit",
refugee_name="",
bypass=false,
refugee_id=""
) %}

{# --- 1. คำนวณสิทธิ์ Bypass ในฝั่ง Server (Jinja) --- #}
{% set is_privileged = bypass %}
{# ถ้า bypass=True หรือ เป็น admin/staff ให้ถือว่าผ่านได้เลย #}
{% set should_bypass = bypass or is_privileged %}

<dialog id="{{ id }}" class="modal modal-bottom sm:modal-middle">
  <div class="modal-box {{ class_ }}">

    <button type="button" class="btn btn-sm btn-circle btn-ghost absolute right-2 top-2 outline-none"
      onclick="document.getElementById('{{ id }}').close();">✕</button>

    <h3 class="font-bold text-xl">{{ title | safe }}</h3>
    <p class="py-4 " style="overflow-wrap: break-word;">{{ body | safe }}</p>

    {% if refugee_name %}
      {# แสดงข้อความเฉพาะเมื่อต้องกรอกชื่อ (ถ้าไม่ Bypass) หรือจะแสดงตลอดก็ได้ตามดีไซน์ #}
      {% if not should_bypass %}
        <p class="mb-2 text-gray-700">โปรดพิมพ์ชื่อผู้อพยพเพื่อยืนยัน: <strong>{{ refugee_name }}</strong></p>
        <p class="mb-2 text-gray-700">Please type the refugee's name to confirm: <strong>{{ refugee_name }}</strong></p>
      {% else %}
         <p class="mb-2 text-green-600 text-sm">
            <i class="fa-solid fa-shield-halved"></i> Staff Override: ไม่จำเป็นต้องพิมพ์ชื่อยืนยัน
         </p>
      {% endif %}
      
      <input class="border p-2 w-full" type="text" id="{{ id }}-refugee-name-input" value="" placeholder='{{ refugee_name }}' autocomplete="off" />
    {% endif %}

    <div class="mt-2">
      <p>
        ไม่สามารถยืนยันข้อมูลได้ใช่ไหม?
        <a class="link" href="{{ url_for('refugees.create_report', type='cannot_back_home') }}">คลิกที่นี่</a>
      </p>
    </div>

    
    <div class="modal-action">
      <form method="{{ method }}" action="{{ action_button_href }}" id="{{ id }}-action-form">
        {# ปุ่มยกเลิก (เปลี่ยน type เป็น button เพื่อกัน submit โดยไม่ตั้งใจ) #}
        <button class="btn" type="button" onclick="document.getElementById('{{ id }}').close();">
          ยกเลิก / Cancel
        </button>
        
        {# ปุ่มยืนยัน เรียก function checkAndSubmit... #}
        <button class="btn btn-outline btn-{{ action_button_color }}" type="button"
          onclick="checkAndSubmit_{{ refugee_id }}()">
          ยืนยัน / Submit
        </button>
      </form>

    </div>
  </div>
  <form method="dialog" class="modal-backdrop"><button>กดเพื่อปิด</button></form>
</dialog>

<script>
  {% if init_show %}
  document.getElementById("{{ id }}").showModal();
  {% endif %}

  // สร้าง Global Function ให้ปุ่มเรียกใช้ได้
  // ใช้ const เพื่อป้องกันการประกาศซ้ำ แต่ต้องระวังถ้า macro ถูกใช้หลายครั้งในหน้าเดียว id ต้องไม่ซ้ำ
  var checkAndSubmit_{{ refugee_id }} = function() {
    
    // ดึงค่าจาก Jinja มาเป็น JS Boolean
    var isBypass = {{ 'true' if should_bypass else 'false' }};
    var targetName = "{{ refugee_name }}";
    
    var form = document.getElementById("{{ id }}-action-form");
    var input = document.getElementById("{{ id }}-refugee-name-input");
    
    // กรณีไม่มีช่อง Input (refugee_name ว่าง) ก็ให้ผ่านเลย
    if (!input) {
      form.submit();
      return;
    }

    // --- Logic ตรวจสอบ ---
    if (isBypass) {
      // ถ้าเป็น Admin/Staff หรือมีค่า bypass=true ให้ส่งฟอร์มได้เลย
      form.submit();
    } else {
      // ถ้าเป็น User ธรรมดา ต้องตรวจชื่อ
      if (input.value.trim() === targetName) {
        form.submit();
      } else {
        alert("ชื่อไม่ถูกต้อง! กรุณากรอกชื่อให้ตรงกับ '" + targetName + "' เพื่อยืนยัน\n\nIncorrect name! Please type '" + targetName + "' to confirm.");
        // focus กลับไปที่ input
        input.focus(); 
      }
    }
  };
</script>
{% endmacro %}

{% macro ChangeRefugeeCampDialog(
  id,
  title="ยืนยันการเปลี่ยนศูนย์พักพิงผู้อพยพ",
  body="คุณต้องการที่จะเปลี่ยนศูนย์พักพิงผู้อพยพชื่อ <b>%s</b> ใช่หรือไม่?" | format(refugee.name),
  refugee_name="",
  refugee_id="",
  current_camp_id="",
  form_action=url_for("refugees.change_camp", refugee_id=refugee.id, camp_id=change_camp_form.refugee_camp.data, **request.args),
  change_camp_form=change_camp_form
) %}

<dialog id="{{ id }}" class="modal modal-bottom sm:modal-middle">
  <div class="modal-box {{ class_ }}">
    {% if close_at_corner %}
    <button type="button" class="btn btn-sm btn-circle btn-ghost absolute right-2 top-2 outline-none"
      onclick="document.getElementById('{{ id }}').close();">✕</button>
    {% endif %}

    <h3 class="font-bold text-xl">{{ title | safe }}</h3>
    <p class="py-4" style="overflow-wrap: break-word;">{{ body | safe }}</p>

    <form method="POST" action="{{ form_action }}" >
      <div class="form-control w-full max-w-xs">
        <fieldset class="w-full">
          <label class="label">
            <span class="label-text">เลือกศูนย์พักพิงผู้อพยพ / Select Refugee Camp</span>
          </label>
          <select id="{{ id }}_select_field" name="refugee_camp" class="select select-bordered w-full max-w-xs">
            <option value="" disabled selected>-- เลือกศูนย์พักพิงผู้อพยพ -- / -- Select Refugee Camp --</option>
            {% for camp in change_camp_form.refugee_camp.choices %}
              <option value="{{ camp[0]|string }}" {% if camp[0]|string == current_camp_id|string %} disabled {% endif %}>
                {{ camp[1] }} 
                {% if camp[0]|string == current_camp_id|string %}
                 (ศูนย์พักพิงปัจจุบัน / Current Camp) 
                {% endif %}
              </option>
            {% endfor %}
          </select>
        </fieldset>

      </div>

      <div class="modal-action flex flex-col sm:flex-row gap-2">
        <button type="button" class="btn" onclick="document.getElementById('{{ id }}').close();">
          ยกเลิก / Cancel
        </button>
        <button type="button" id="{{ id }}-change_camp-submit" class="btn btn-primary">
          ยืนยันการเปลี่ยนศูนย์พักพิง / Confirm Change
        </button>
      </div>
    </form>   
  </div>

  {% if click_outside_to_close %}
  <form method="dialog" class="modal-backdrop"><button>กดเพื่อปิด</button></form>
  {% endif %}
</dialog>

<script>
  let select_field_{{ id }} = document.getElementById("{{ id }}_select_field");
  console.log("Select field found:", select_field_{{ id }});
  select_field_{{ id }}.addEventListener('change', function() {
    // This function will execute when the selected option changes
    const selectedValue = this.value; // 'this' refers to the select element
    console.log('Selected value:', selectedValue);

    // Perform DOM manipulation or other actions based on the selected value
    // Example: Update a paragraph with the selected value
    document.getElementById('outputParagraph').textContent = 'You selected: ' + selectedValue;
  });
  {# When submit add query string to action form <camp_id>#}
  
  document.getElementById("{{ id }}-change_camp-submit").addEventListener("click", function() {
  var form = this.closest("form");
  var selectElement = select_field_{{ id }};
  
  console.log("Looking for element ID:", "{{ id }}_select_field");
  console.log("Select element found:", selectElement);
  var selectedCampId = selectElement ? selectElement.value : "";

  // Check if no camp is selected or if the default option is selected
  if (!selectedCampId || selectedCampId === "") {
    alert("กรุณาเลือกศูนย์พักพิงผู้อพยพ / Please select a refugee camp");
    return;
  }

  // Update form action with selected camp_id as query parameter
  var baseAction = "{{ url_for('refugees.change_camp', refugee_id=refugee_id, camp_id='' ) }}";
  form.action = baseAction + selectedCampId + "?{{ request.query_string.decode('utf-8') }}";

  console.log("Final form action:", form.action);
  form.submit();
});
</script>
{% endmacro %}
