{% extends "/base/default_page.html" %}
{% import "base/html_renderer.html" as renderer %}
{% import "/components/dialogs.html" as dialog %}
{% import "/components/paginations.html" as paginations %}

{% set title_page="รายชื่อผู้อพยพ / Migrants List" %}

{% block content %}

{% if not current_user.is_authenticated %}
<div class="mb-4">
    <a href="{{ url_for('index.index') }}">
        <i class="ph ph-arrow-left text-lg"></i>
        กลับไปหน้าหลัก / Back to Home
    </a>
</div>
{% endif %}

<div class="bg-white rounded-3xl border border-gray-300">
    <div class="overflow-x-auto p-6">
        <div class="flex flex-row max-sm:flex-col w-full sm:items-end justify-between mb-2 gap-4">
            <form method="GET">
                <div class="text-xl font-medium text-gray-700">
                    รายชื่อผู้อพยพ / Migrants List
                </div>
                <div class="grid grid-cols-5 max-md:grid-cols-2 max-sm:grid-cols-1 gap-x-4 items-center">
                    {{ renderer.base_render(search_form.refugee_camp, class="w-full h-full px-3", class_="!p-0") }}
                    {{ renderer.base_render(search_form.search) }}
                    <input name="view_mode" type="hidden" value="{{ view_mode }}">
                    {% if current_user.is_authenticated and ("admin" in current_user.roles or "refugee_camp_staff" in current_user.roles)%}
                        {{ renderer.base_render(search_form.country) }}
                        <div class="space-y-2">
                            <p class="text-xs fieldset-legend">ไม่แสดงประเทศไทย</p>
                            <input
                                type="checkbox"
                                name="exclude_thai"
                                class="toggle toggle-primary"
                                {% if request.args.get('exclude_thai') %}checked{% endif %}
                            />
                        </div>
                    {% endif %}
                    <button type="submit" class="btn btn-primary text-white sm:mt-8 max-sm:mt-3">
                        <span class="ph ph-magnifying-glass text-lg"></span>
                        ค้นหา / Search
                    </button>
                </div>
            </form>
            {% if 'admin' in current_user.roles or 'refugee_camp_staff' in current_user.roles %}
            <a class="btn btn-primary text-white mb-1" href="{{ url_for('refugees.create_or_edit', **request.args) }}">
                <span class="material-symbols-outlined text-sm">add</span>
                เพิ่มผู้อพยพ / Add Migrant
            </a>
            {% endif %}
        </div>
        {% if not search_form.search.data and ("refugee_camp_staff" not in current_user.roles and "admin" not in current_user.roles) %}
            <div class="mb-4 text-sm text-gray-600 italic">
                * รายชื่อผู้อพยพจะไม่แสดง จนกว่าจะระบุคำค้นหาในช่อง <span class="font-medium">"ค้นหา / Search"</span> ด้านบน
            </div>
        {% endif %}
        {% set args = request.args.to_dict() %}
        {% set _ = args.pop('view_mode', None) %}
        <div class="w-full flex justify-end mb-4">
            <div class="max-sm:w-full max-sm:grid grid-cols-2 border border-gray-300 rounded p-1 w-fit">
                <a href="{{ url_for('refugees.index', view_mode='grid', **args) }}"
                    class="btn {{ 'bg-black text-white' if view_mode == 'grid' else ''}}">
                    ดูแบบการ์ด
                    <span class="text-lg ph ph-squares-four"></span>
                </a>
                <a href="{{ url_for('refugees.index', view_mode='list', **args) }}"
                    class="btn {{ 'bg-black text-white' if view_mode == 'list' else ''}}">
                    ดูแบบตาราง
                    <span class="text-lg ph ph-list-dashes"></span>
                </a>
            </div>
        </div>
        {% if view_mode == 'grid' %}
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
            {% for refugee in refugees_pagination.items %}
            <div>
                <div class="card bg-base-100 shadow-md">
                    <div class="card-body p-4">
                        <h2 class="card-title flex items-start justify-between gap-2">
                            <div>
                                {{ loop.index}}. {{ refugee.name }} {{ ("(" + refugee.nick_name + ")") if
                                refugee.nick_name else "" }}
                            </div>
                            {% if "admin" in current_user.roles %}
                            <div class="card-actions flex-nowrap items-start justify-end">
                                <a href="{{ url_for('refugees.create_or_edit', refugee_id=refugee.id) }}"
                                    class="w-7 h-7 btn btn-outline btn-sm text-gray-600 border-gray-300">
                                    <span class="material-symbols-outlined">
                                        edit_square
                                    </span>
                                </a>
                                <button class="w-7 h-7 btn btn-outline btn-sm border-gray-300 text-error"
                                    onclick="$('#{{refugee.id}}-disactive-dialog')[0].showModal()">
                                    <span class="material-symbols-outlined">
                                        delete
                                    </span>
                                </button>
                                {{ dialog.DisactiveDialog(
                                    id="%s-disactive-dialog" | format(refugee.id),
                                    title="ยืนยันการลบรายการผู้อพยพ",
                                    body="คุณต้องการที่จะลบรายการผู้อพยพชื่อ <b>%s</b> ใช่หรือไม่?" | format(refugee.name),
                                    url=url_for("refugees.delete_refugee", refugee_id=refugee.id)
                                )}}
                            </div>
                            {% endif %}
                        </h2>
                        <div>
                            <p class="text-gray-500 font-light">ศูนย์พักพิง / Migrant Camp</p>
                            {% set camp_args = request.args.to_dict() %}
                            {% set _ = camp_args.pop('refugee_camp', None) %}
                            <a class="underline text-black cursor-pointer" href="{{ url_for('refugees.index', refugee_camp=refugee.refugee_camp.id, **camp_args) }}">{{ refugee.refugee_camp.name }}</a>
                        </div>
                        {{ render_refugee_status(refugee.status) }}
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
        {% else %}
            <table class="table w-full text-sm border border-gray-200">
                <thead class="text-gray-700 bg-gray-50">
                    <tr>
                        <th class="text-center">ลำดับ</th>
                        <th class="text-left">ชื่อเล่น</th>
                        <th class="text-left">ชื่อ-นามสกุล</th>
                        <th class="text-left">ลงทะเบียนเมื่อ</th>
                        {% if current_user.is_authenticated and ("admin" in current_user.roles or "refugee_camp_staff" in current_user.roles)%}
                            <th class="text-left">ประเทศ</th>
                        {% endif %}
                        <th class="text-left">สถานะ</th>
                        <th class="text-left">ศูนย์พักพิง</th>
                        <th class="text-left">ข้อมูลล่าสุด</th>
                        <th class="text-right">จัดการ</th>
                    </tr>
                </thead>

                <tbody>
                    {% for refugee in refugees_pagination.items %}
                    <tr class="border-b border-gray-200 hover:bg-gray-50">
                        
                        <!-- ลำดับ -->
                        <td class="text-center px-4 py-3">
                            {{ loop.index }}
                        </td>

                        <td class="px-4 py-3">
                            {{ refugee.nick_name if refugee.nick_name else '-' }}
                        </td>

                        <td class="px-4 py-3">
                            {{ refugee.name }}
                        </td>

                        <td class="px-4 py-3">
                            {{ refugee.registration_date.strftime("%d %B %Y") }}
                        </td>

                        {% if current_user.is_authenticated and ("admin" in current_user.roles or "refugee_camp_staff" in current_user.roles)%}
                             <td class="px-4 py-3">
                            {{ refugee.country if refugee.country else '-' }}
                        </td>
                        {% endif %}

                        <td class="px-4 py-3">
                            {{ render_refugee_status(refugee.status) }}
                        </td>

                        <td class="px-4 py-3">
                            {% set camp_args = request.args.to_dict() %}
                            {% set _ = camp_args.pop('refugee_camp', None) %}
                            <a class="underline text-black cursor-pointer" href="{{ url_for('refugees.index', refugee_camp=refugee.refugee_camp.id, **camp_args) }}">{{ refugee.refugee_camp.name }}</a>
                        </td>

                        <td class="px-4 py-3">
                            {{ refugee.updated_date.strftime("%d %B %Y") }}
                        </td>

                        <!-- ปุ่มจัดการ -->
                        <td class="px-4 py-3">
                            <div class="flex gap-2 justify-end">

                                <a href="{{ url_for('refugees.create_or_edit', refugee_id=refugee.id) }}"
                                    class="btn btn-outline btn-sm text-gray-600 border-gray-300">
                                    <span class="material-symbols-outlined">edit_square</span>
                                </a>

                                <button class="btn btn-outline btn-sm border-gray-300 text-error"
                                    onclick="$('#{{refugee.id}}-disactive-dialog')[0].showModal()">
                                    <span class="material-symbols-outlined">delete</span>
                                </button>

                                {{ dialog.DisactiveDialog(
                                    id="%s-disactive-dialog" | format(refugee.id),
                                    title="ยืนยันการลบรายการผู้อพยพ",
                                    body="คุณต้องการที่จะลบรายการผู้อพยพชื่อ <b>%s</b> ใช่หรือไม่?" | format(refugee.name),
                                    url=url_for("refugees.delete_refugee", refugee_id=refugee.id)
                                )}}
                            </div>
                        </td>

                    </tr>
                    {% endfor %}
                </tbody>
            </table>

        {% endif %}
        {% if search_form.search.data and not refugees %}
            <div class="mt-4 py-4 text-center text-gray-500 italic">
                ไม่พบผู้อพยพที่ตรงกับคำค้นหา
            </div>
        {% endif %}
        {{ paginations.render_pagination(
            pagination=refugees_pagination,
            endpoint='refugees.index',
            key_page='page',
            kwargs=request.args.to_dict()
        ) }}
    </div>
</div>
{% endblock %}

{% macro render_refugee_status(status) %}
<div class="border rounded-lg py-0.5 px-1.5 size-fit
    {{ 'text-blue-500 border-blue-500' if status == 'active' else '' }}
    {{ 'text-red-500 border-red-500' if status == 'deactive' else '' }}
    {{ 'text-green-500 border-green-500' if status == 'back_home' else '' }}
        ">
    {{ 'อยู่ในศูนย์พักพิง / In Migrants Camp' if status == 'active' else '' }}
    {{ 'ถูกลบออก / Deleted' if status == 'deactive' else '' }}
    {{ 'กลับบ้านแล้ว / Returned Home' if status == 'back_home' else '' }}
</div>
{% endmacro %}